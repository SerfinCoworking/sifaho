<%= render 'header' %>

<div class="card fixed-custom-card">
  <div class="card-header d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <%= fa_icon "eye" %>
      <h5 class="card-title mb-0 ml-2">
        Viendo <%= @external_order.order_type %>
      </h5>
    </div>
    <div>
      <%= link_to external_order_path(format: 'pdf'), class: 'btn',  
        :title => 'Imprimir pdf', :'data-placement'=>'top', :'data-toggle'=>'tooltip', target: :_blank do %>
        <%= fa_icon "print" %>
      <% end %>
      <%= link_to (@external_order.is_applicant?(current_user) ? applicant_index_external_orders_path : provider_index_external_orders_path), class: 'btn',
          :title => 'Cerrar', :'data-placement'=>'top', :'data-toggle'=>'tooltip' do %>
        <%= fa_icon "times" %>
      <% end %>
    </div>
  </div>

  <div class="card-body">
    <div class="row">
      <div class='col-2'>
        <strong>Sector solicitante:</strong>
        <%= @external_order.applicant_sector.name%>
      </div>
      <div class="col-2">
        <strong>Sector proveedor:</strong>
        <%= @external_order.provider_sector.name%>
      </div>
      <div class='col-3'>
        <strong>Solicitado:</strong>
        <%= @external_order.requested_date.strftime("%d/%m/%Y")%>
      </div>
      <div class='col-3'>
        <strong>Observaciones:</strong>
          <%= @external_order.observation? ? @external_order.observation : 'Sin observaciones' %>
      </div>
      <div class='col-2'>
        <strong>Código:</strong>
        <%= @external_order.remit_code %>
      </div>
    </div>
    
    <!-- Status bar -->
    <hr>
    <div class="row">
      <div class="col-12">
        <%= render 'shared/status_bar', order: @external_order %>
      </div>
    </div>

    <!-- Tabs -->
    <div class="row mt-3">
      <div class="col-12">
        <ul class='nav nav-tabs nav-justified'>
          <li class='nav-item'>
            <a class="nav-link active" data-toggle='tab' href='#products' role="tab">
              <%= fa_icon "cubes" %> Productos
              <span class="badge badge-secondary"><%= @external_order.external_order_products.count %></span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-toggle='tab' href='#last-movements' role="tab">
              <%= fa_icon "exchange-alt" %> Movimientos
              <span class="badge badge-secondary"><%= @external_order.movements.count %></span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-toggle='tab' href='#comments' role="tab">
              <%= fa_icon "exchange-alt" %> Comentarios
              <span class="badge badge-secondary" id="comments-count"><%= @external_order.comments.count %></span>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="tab-content">
      <div id='products' class='tab-pane fade show active'>
        <!-- Insumos a dispensar -->
        <div class="card">
          <table class="table table-hover table-sm">
            <thead>
              <tr>
                <th>Código</th>
                <th>Producto</th>
                <th>Unidad</th>
                <th>Solicitado</th>
                <th><%= @external_order.provision_entregada? ? 'Entregado' : 'A entregar' %></th>
                <th>Lotes</th>
                <th>Observaciones</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% @external_order.external_order_products.joins(:product).order("name").each do |ext_ord_prod| %>
                <tr>
                  <td>
                    <%= ext_ord_prod.product_code %>
                  </td>
                  <td>
                    <%= ext_ord_prod.product_name %>
                  </td>
                  <td>
                    <%= ext_ord_prod.unity %>
                  </td>
                  <td>
                    <%= ext_ord_prod.request_quantity %> 
                  </td>
                  <td>
                    <%= ext_ord_prod.delivery_quantity %>
                  </td>
                  <td>
                    <button class="btn btn-primary btn-sm" type="button" data-toggle="collapse" data-target="#collapse-row-<%= ext_ord_prod.id %>" aria-expanded="false" aria-controls="collapse-row-<%= ext_ord_prod.id %>">
                      <%= ext_ord_prod.order_prod_lot_stocks.count %>
                    </button>
                  </td>
                  <td>
                    <% if ext_ord_prod.provider_observation.present? || ext_ord_prod.applicant_observation.present? %>
                      <%= fa_icon "asterisk" %>
                    <% else %>
                      ---
                    <% end %>
                  </td>
                </tr>
                <tr>
                  <td colspan="7" class="p-0">
                    <div id="collapse-row-<%= ext_ord_prod.id %>" class="collapse in">
                      <div class="p-3">
                      <% if ext_ord_prod.order_prod_lot_stocks.present? %>
                        <table class="w-100">
                          <thead>
                            <tr>
                              <th> Cantidad </th>
                              <th> Lote </th>
                              <th> Laboratorio </th>
                              <th> Vencimiento </th>
                            </tr>
                          </thead>
                          </tbody>
                            <% ext_ord_prod.order_prod_lot_stocks.each do |eopls| %>
                            <tr>

                              <td>
                                <%= eopls.quantity %>
                              </td>
                              
                              <td>
                                <%= eopls.lot_stock.lot.code %>
                              </td>
                              
                              <td>
                                <%= eopls.lot_stock.lot.laboratory.name %>
                              </td>
                              
                              <td>
                                <%= eopls.lot_stock.lot.expiry_date.present? ? eopls.lot_stock.lot.expiry_date.strftime("%m/%y") : "Sin asignar" %>
                              </td>
                            </tr>

                            <% end %>
                          </tbody>
                        </table>
                        <% if ext_ord_prod.provider_observation.present? || ext_ord_prod.applicant_observation.present? %>
                          <table class="w-100">
                            <tr>
                              <th>Descripción solicitud</th>
                              <th>Descripción proveedor</th>
                            </tr>
                            <tr>
                              <td><%= ext_ord_prod.provider_observation %></td>
                              <td><%= ext_ord_prod.applicant_observation %></td>
                            </tr>
                          </table>
                        <%end%>
                        <% else %>
                            No tiene lotes asignados
                        <% end %>
                      </div>
                    </div>
                  </td>
                </tr> <%# fin Listado de lotes y descripciones %>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
      <div id='last-movements' class='tab-pane fade'>
        <!-- Tabla de movimientos -->
        <%= render '/shared/movements_table', order: @external_order %>
      </div> <!-- End last movements tab pane -->
      <div id='comments' class='tab-pane fade'>
        <!-- Tabla de movimientos -->
        <%= render '/shared/comments', order: @external_order, new_comment: ExternalOrderComment.new %>
      </div> <!-- End comments tab pane -->
    </div> <!-- End Tab content-->
  </div>
  <div class="card-footer d-flex justify-content-between">
    <% if policy(@external_order).nullify? %>
      <span data-toggle="modal" data-target="#anular-confirm">
        <button class="btn btn-danger btn-sm" data-toggle='tooltip' title="Anular solicitud" >
          <%= fa_icon 'ban' %>
        </button>
      </span>
    <% end %>
    <div class="text-right w-100">
      <%= link_to (@external_order.is_applicant?(current_user) ? applicant_index_external_orders_path : provider_index_external_orders_path),  
        'data-disable-with' => "Volviendo... <i class='fa fa-spinner fa-spin'></i>".html_safe,
        class: "btn btn-light mr-1" do %>
        Volver
      <% end %>

      <% if policy(@external_order).edit_provider? %>
        <%= link_to edit_provider_external_order_path(@external_order), :"data-turbolinks" => false,
          'data-disable-with' => "Editar... <i class='fa fa-spinner fa-spin'></i>".html_safe,
          class: "btn btn-warning mr-1" do %>
          <%= fa_icon "pen" %>
          Editar
        <% end %>
      <% end %> 
      <% if policy(@external_order).edit_applicant? %>
        <%= link_to edit_applicant_external_order_path(@external_order),  
          'data-disable-with' => "Editar... <i class='fa fa-spinner fa-spin'></i>".html_safe,
          class: 'btn btn-warning btn-md mr-1' do %>
          <%= fa_icon "pen" %>
          Editar
        <% end %>
      <% end %>

      <% if policy(@external_order).send_applicant? %>
        <%= link_to send_applicant_external_order_path(@external_order), 
          'data-disable-with' => "Enviando... <i class='fa fa-spinner fa-spin'></i>".html_safe,
          class: 'btn btn-primary btn-md mr-1' do %>
          <%= fa_icon "paper-plane" %>
          Enviar solicitud
        <% end %>
      <% end %>
      <% if policy(@external_order).return_provider_status? || policy(@external_order).return_applicant_status? %>
        <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#return-confirm">
          <%= fa_icon "redo" %>
          Retornar
        </button>
      <% end %>
      
      <% if policy(@external_order).accept_provider? %>
        <%= link_to accept_provider_external_order_path(@external_order),  
          'data-disable-with' => "Aceptar... <i class='fa fa-spinner fa-spin'></i>".html_safe,
          class: 'btn btn-primary btn-md mr-1' do %>
          <%= fa_icon "thumbs-up" %> Aceptar
        <% end %>
      <% end %>

      <% if policy(@external_order).send_provider? %>
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#send-confirm">
          <%= fa_icon "paper-plane" %>
          Enviar provisión
        </button>
      <% end %>
      
      <% if policy(@external_order).receive_applicant? %>
        <button type="button" class="btn btn-success btn-md" data-toggle="modal" data-target="#receive-confirm">
          <%= fa_icon "check" %>
          Recibir
        </button>
      <% end %>
    </div> <!-- fin botones right -->
  </div>
</div>

<% content_for :modal do %>
  <%# Retornar a un estado anterior (solo solicitudes enviadas o entregas aceptadas)%>
  <% if policy(@external_order).return_provider_status? || policy(@external_order).return_applicant_status? %>
    <div class="modal" id="return-confirm">
      <div class="modal-dialog">
        <div class="modal-content panel-warning">
          <div class="modal-header panel-heading">
            <h5 class="m-0"><%= fa_icon "redo" %> Retornar a <%= prev_status = ExternalOrder.statuses.key(@external_order.status_before_type_cast - 1).underscore.humanize %></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Seguro que desea retornar la <%= @external_order.order_type %> actual a <%= prev_status %>?</p>
          </div>
          <div class="modal-footer text-right">
            <a href="#" data-dismiss="modal" class="btn">Cancelar</a>
            <% if policy(@external_order).return_applicant_status? %>
              <%= link_to 'Confirmar', return_applicant_status_external_order_path(@external_order), method: :get, 'data-disable-with' => "Enviando... <i class='fa fa-spinner fa-spin'></i>".html_safe, :class => 'btn btn-warning' %>
            <% else %>
              <%= link_to 'Confirmar', return_provider_status_external_order_path(@external_order), method: :get, 'data-disable-with' => "Enviando... <i class='fa fa-spinner fa-spin'></i>".html_safe, :class => 'btn btn-warning' %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
  
  <%# Recibo de orden (solo en proveedor en camino) %>
  <% if policy(@external_order).receive_applicant? %>
    <div class="modal fade" id="receive-confirm">
      <div class="modal-dialog">
        <div class="modal-content panel-warning">
          <div class="modal-header panel-heading">
            <h5 class="m-0"><%= fa_icon "check" %> Confirmar recibo de <%= ExternalOrder.statuses.key(@external_order.status_before_type_cast - 1).underscore.humanize %></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Esta seguro que ha recibido el pedido?</p>
          </div>
          <div class="modal-footer text-right">
            <a href="#" data-dismiss="modal" class="btn">Cancelar</a>
            <%= link_to 'Confirmar', receive_applicant_external_order_path(@external_order), method: :get, 'data-disable-with' => "Enviando... <i class='fa fa-spinner fa-spin'></i>".html_safe, :class => 'btn btn-success' %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
  
  <%# Enviar provision (solo en provision aceptada) %>
  <% if policy(@external_order).send_provider? %>
    <div class="modal fade" id="send-confirm">
      <div class="modal-dialog">
        <div class="modal-content panel-warning">
          <div class="modal-header panel-heading">
            <h5 class="m-0"><%= fa_icon "check" %> Confirmar envío de <%= ExternalOrder.statuses.key(@external_order.status_before_type_cast - 1).underscore.humanize %></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Esta seguro de enviar el pedido?</p>
          </div>
          <div class="modal-footer text-right">
            <a href="#" data-dismiss="modal" class="btn">Cancelar</a>
            <%= link_to 'Confirmar', send_provider_external_order_path(@external_order), method: :get, 'data-disable-with' => "Enviando... <i class='fa fa-spinner fa-spin'></i>".html_safe, :class => 'btn btn-success' %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
  
  <%# Anular orden (solo en solicitudes enviadas) %>
  <% if policy(@external_order).nullify? %>
    <div class="modal fade" id="anular-confirm">
      <div class="modal-dialog">
        <div class="modal-content panel-warning">
          <div class="modal-header panel-heading">
            <h5 class="m-0"><%= fa_icon "check" %> Confirmar anulación de <%= ExternalOrder.statuses.key(@external_order.status_before_type_cast - 1).underscore.humanize %></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Esta seguro de anular el pedido?</p>
          </div>
          <div class="modal-footer text-right">
            <a href="#" data-dismiss="modal" class="btn">Cancelar</a>
            <%#= link_to 'Anular', nullify_external_order_path(@external_order), method: :get, 'data-disable-with' => "Enviando... <i class='fa fa-spinner fa-spin'></i>".html_safe, :class => 'btn btn-danger' %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
<% end %>